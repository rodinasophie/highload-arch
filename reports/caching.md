# Кеширование  
Данная домашняя работа была направлена на изучение кеширования в высоконагруженных системах. В качестве кеша был использован Redis, инвалидация кеша поддерживается через опережающее кеширование, все запросы на чтение с бэкенда идут в кеш, раз в указанный период происходит обновление кеша и данные синхронизируются с базой. В кеше хранятся последние 1000 постов.

Схема базы данных:
```sql
CREATE TABLE IF NOT EXISTS friends (
    user_id UUID REFERENCES users(id)  NOT NULL,
    friend_id UUID REFERENCES users(id) NOT NULL,
    PRIMARY KEY(user_id, friend_id) 
);

CREATE TABLE IF NOT EXISTS posts (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    author_user_id UUID NOT NULL,
    text VARCHAR(1000) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL
);

```

В кеше помимо списка постов, хранится маппинг пользователь-друг для корректной фильтрации выдачи.

Следующие докер-контейнеры были созданы для сборки стенда:
1. База данных(лидер + 1 реплика)
2. Сервер бэкенда
3. Redis-кеш.

В рамках данной домашней работы также были реализованы следующие эндпоинты:
1. `/friend/add, /friend/delete`
2. `/post/create, /post/update, /post/delete, /post/get`
3. `/post/feed`

Генерация постов происходит при помощи Python-библиотеки `faker`.

Дополнительно был создан скрипт инициализации системы при помощи REST API:
1. Создание пользователей из ранее сгенеренных данных
2. Создание пар друзей по указанному правилу(см. файл `generate/initialize_system.py`)
3. Создание постов пользователями
4. Получение списка постов(по умолчанию `offset=0, limit=2`) 

Для запуска стенда следует использовать следующие команды:
`make docker-reset && make docker-init && make docker-cache && make docker-backend && make docker-run && make init-system`

Сервер доступен на `http://localhost:8083/`

## Обновлено. Эффект Леди Гаги
В рамках данного дополнения была добавлена поддержка эффекта Леди Гаги при генерации ленты новостей. В настоящий момент пользователи делятся на тех, у кого в базе есть флаг `celebrity=true` и те, у кого `celebrity=false`. Большое число подписчиков(`СELEBRITY_THRESHOLD`) переводит флаг в `celebrity=true`. Если пользователь обычный, то добавление поста вызывает запись в базу и обновление кеша в момент очередного этапа синхронизации кеша и базы данных. Если пользователь имеет статус `celebrity=true`, то ввиду большого количества потенциальных одномоментных обновлений кеша, отправляется сообщение о добавлении поста для данного пользователя и кеш обновляется частями при прочтении данного сообщения из очереди.